<!DOCTYPE html>
<script src="{{ url_for('static',filename='js/plotly-latest.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/d3.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/jquery.min.js') }}"></script>
<link href="{{ url_for('static',filename='css/bootstrap.min.css') }}" rel="stylesheet" type= "text/css">
<script src="{{ url_for('static',filename='js/popper.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/bootstrap.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/bootstrap-select.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/sweetalert2@11.js') }}"></script> 
<link rel="stylesheet" href="{{ url_for('static',filename='css/bootstrap-select.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static',filename='css/style.css') }}">
<script src="{{ url_for('static',filename='js/epivizor.js') }}"></script>


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>EpiVizor</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>




<body>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages and render_splash_screen == False %}
    <script>
        if (typeof msg === 'undefined') {
            let msg=''
        }    
        msg = "<div class='text-start'><ul>" + 
                  {% for category, m in messages %}
                   "<li>{{ m }}</li>"+
                  {% endfor %}
                   "</ul></div>"          
        Swal.fire({
            title: "Info",
            html: msg        
            }); 
    </script>
  {% endif %}
{% endwith %}

{% if render_splash_screen %}
<div id="overlay">
    <h1 style="text-align: center">Validation screen</h1>
    <p style="text-align: center">Validate and map data fields to be rendered.
        If field names defer from defaults, perform column mapping below. Check expected and observed field types.</p>

    <p style="text-align: center">Input file name: <b>{{file_uploaded}}</b>. Uploaded data shape (#rows, #columns):
        <b>{{metadata['data_shape']}}</b>.
    </p>
    <!--p style="text-align:center;"><b>Delimiter symbol</b> separating individual values in profile and hierarchical fields:
        <select class="form-select" id="delimiter_selector" style="width:70px;display:inline">
            <option>|</option>
            <option>||</option>
            <option>;</option>
            <option>:</option>
            <option>*</option>
            <option>$</option>
            <option>=</option>
            <option>-</option>
            <option>#</option>
            <option>@</option>
            <option>^</option>
            <option>+</option>
            <option>,</option>
            <option>.</option>
            <option>/</option>
            <option>\</option>
        </select>
    </p-->

    <table class='input_variables_table'>
        <caption>Input variables summary and mapping table</caption>
        <tr>
            <th>Info</th>
            <th>Selected field&nbsp;
                <div class="tooltip">
                <img id="lock_button" onclick="unlock_observed_fields()""; src={{ url_for('static',filename='lock_open_icon.png')}}>
                <span class="tooltiptext">Click to unlock the dropdowns</span>
                </div>
            </th>
            <th>Default field</th>
            <th>Default type</th>
            <th>Total</th>
            <th>Unique</th>
            <th>Missing</th>
            <th>Delimiter</th>
            <th>Warnings</th>
            

        </tr>
        {%for field_exp in metadata['fields_types_expected'] | sort(case_sensitive=False) %}
            <tr id={{ field_exp }}>
                <td><div class="tooltip">
                    <img style="width: 20px; height: 20px"
                         src="{{ url_for('static',filename='info_icon.png')}}"/>
                    <span class="tooltiptext">{{metadata['fields_types_expected_info'][field_exp]}}</span>
                    </div>
                </td>
                <td>
                    <select class="form-select" onchange=update_validate_table_row(this.value,"{{field_exp}}",document.getElementById("{{ field_exp }}"))
                    {% if field_exp in metadata['fields_observed'] %}
                        disabled>
                        <option></option>
                        <option selected>{{field_exp}}</option>
                    {% else %}
                               >
                        <option selected>{{metadata['fields_observed'].last}}</option>
                    {% endif %}
                        
                    {%for field_obs in metadata['fields_observed'] %}
                        <option value="{{field_obs}}">{{field_obs}}</option>
                    {%endfor%}
                    </select>
                </td>
                <td>{{field_exp}}</td>
                <td>{{metadata['fields_types_expected'][field_exp]}}</td>
                <td>{%if field_exp in metadata['fields_counts_observed']%}{{metadata['fields_counts_observed'][field_exp]}}{%else%}-{%endif%}</td>
                <td>{%if field_exp in metadata['fields_counts_unique_observed']%}{{metadata['fields_counts_unique_observed'][field_exp]}}{%else%}-{%endif%}</td>
                <td>{%if field_exp in metadata['fields_counts_missing_observed']%}{{metadata['fields_counts_missing_observed'][field_exp]}}{%else%}-{%endif%}</td>
                <td>
                    {% if 'list' in metadata['fields_types_expected'][field_exp] %}
                    <select class="delimiter_selector" onchange=update_delimiter_all_selector(this) style="width:70px;display:inline">
                        <option>|</option>
                        <option>||</option>
                        <option>;</option>
                        <option>:</option>
                        <option>*</option>
                        <option>$</option>
                        <option>=</option>
                        <option>-</option>
                        <option>#</option>
                        <option>@</option>
                        <option>^</option>
                        <option>+</option>
                        <option>,</option>
                        <option>.</option>
                        <option>/</option>
                        <option>\</option>
                    </select>
                    {% else %}
                    -
                    {% endif%}
                </td>
                <td>
                {% if field_exp in metadata['fields_observed']%}
                    {%if metadata['warnings'][field_exp]|length == 0 %}
                    -
                    {% else %}
                    {{metadata['warnings'][field_exp]}}
                    {% endif %}
                {% else %}
                    The <b>'{{field_exp }}'</b> field is not found
                {% endif %}
                </td>    
               
                
            </tr>
        {%endfor%}
    </table>
    <br>
    <div style="text-align: center">
        <button type="button" onclick="submitValidatedFields()" class="btn btn-primary center">SUBMIT</button>
        <button type="button" onclick="location.href='/';" class="btn btn-danger center">CANCEL</button>
    </div>
</div>
{% endif %}


<div class="flex-container">
    <div id="navbar" class="shadow">
        <div id="container_filters_div">
            <div class="accordion" id="myAccordion">
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span class="accordion-button collapsed fw-bold text-break" data-bs-toggle="collapse"
                              data-bs-target="#accordion_section_filters_subset1">FILTERS GROUP #1</span>
                    </div>
                    <div class="accordion-body collapse" id="accordion_section_filters_subset1">
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#primary_type_filter1">
                                    Primary type
                                    {% if 'primary_type' in session['validatedfields_exp2obs_map'] %}
                                    ({{session['validatedfields_exp2obs_map']['primary_type']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="primary_type_filter1" class="accordion-collapse collapse">
                                <!--div class="dropdown bootstrap-select show-tick"--> <!--Field Organism-->
                                    <select class="d-inline selectpicker" id="select_primary_type_filterset1" data-size="10"
                                            data-live-search="true" data-actions-box="true"
                                            name="select_primary_type_filterset1" multiple="true" tabindex="null">
                                        {% if 'primary_type' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['primary_type'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#secondary_type_filter1">
                                    Secondary type
                                    {% if 'secondary_type' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['secondary_type']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="secondary_type_filter1" class="accordion-collapse collapse"> <!--Field Type-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_secondary_type_filterset1" data-size="10"
                                            data-live-search="true" data-container="body" data-actions-box="true"
                                            name="select_serotypes_filterset1" multiple="true" tabindex="null" data-live-search="true">
                                        {% if 'secondary_type' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['secondary_type'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#genetic_profile_filter1">
                                    Genetic profile
                                    {% if 'genetic_profile' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['genetic_profile']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="genetic_profile_filter1" class="accordion-collapse collapse">
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_genetic_profile_filterset1"
                                            data-size="10" data-actions-box="true"
                                            name="select_genetic_profile_filterset1" multiple="true" tabindex="null"
                                            data-live-search="true">
                                        {% if 'genetic_profile' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['genetic_profile'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#phenotypic_profile_filter1">
                                    Phenotypic profile
                                    {% if 'phenotypic_profile' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['phenotypic_profile']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="phenotypic_profile_filter1" class="accordion-collapse collapse"> <!--Field SISTR-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_phenotypic_profile_filterset1"
                                            data-size="10" data-actions-box="true"
                                            name="select_phenotypic_profile_filterset1" multiple="true" tabindex="null"
                                            data-live-search="true">
                                        {% if 'phenotypic_profile' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['phenotypic_profile'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#date_range_filter1">
                                      Date range 
                                      {% if 'date' in session['validatedfields_exp2obs_map'] %}
                                      ({{session['validatedfields_exp2obs_map']['date']}})
                                      {% endif %}
                                </span>
                            </div>
                            <div id="date_range_filter1" class="accordion-collapse collapse"> <!--Field IsolatDate-->
                                <span>
                                <label for="start_date_filterset1">Start: </label>
                                <input type="date" id="start_date_filterset1" name="start_date_filterset1">
                                <br />
                                <label for="end_date_filterset1">End  :</label>
                                <input type="date" id="end_date_filterset1" name="end_date_filterset1">
                                </span>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#cluster_id_filter1">
                                    Cluster ID
                                    {% if 'cluster_id' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['cluster_id']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="cluster_id_filter1" class="accordion-collapse collapse">
                                <!--Field IsolatDate-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_cluster_id_filterset1"
                                            name="select_cluster_id_filterset1" multiple="true" data-actions-box="true"
                                            data-width="auto" data-size="10" data-live-search="true"
                                            data-container="body">
                                        {% if 'cluster_id' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['cluster_id'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#investigation_id_filter1">
                                    Investigation ID
                                    {% if 'investigation_id' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['investigation_id']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="investigation_id_filter1" class="accordion-collapse collapse">
                                <!--Field IsolatDate-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_investigation_id_filterset1"
                                            name="select_investigation_id_filterset1" multiple="true"
                                            data-width="auto" data-size="10" data-live-search="true"
                                            data-container="body" data-actions-box="true">
                                        {% if 'investigation_id' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['investigation_id'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                    <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                          data-bs-target="#genotype_hierarchy_groups_filter1">
                                        Hierarchical subtypes
                                        {% if 'hierarchical_subtype' in session['validatedfields_exp2obs_map'] %}
                                            ({{session['validatedfields_exp2obs_map']['hierarchical_subtype']}})
                                        {% endif %}
                                    </span>
                            </div>
                            <div id="genotype_hierarchy_groups_filter1" class="accordion-collapse collapse">
                                <!--Field IsolatDate-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    {% for field_name, unique_values in  filters_fields2values_dict.items() %}
                                        {% if 'hs_level_' in field_name %}
                                            <div class="accordion-item">
                                                <div class="accordion-header">
                                                    <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                                        data-bs-target="#{{ field_name }}_f1_accordion_item_content">
                                                        {{ field_name }}
                                                    </span>
                                                </div>
                                                <!--span class="fw-bold">{{ field_name }}</span-->
                                                <div id="{{ field_name }}_f1_accordion_item_content" class="accordion-collapse collapse">
                                                    <select class="d-inline selectpicker"
                                                                     id="select_{{ field_name }}_genotype_hierarchy_groups_filterset1"
                                                                     name="select_{{ field_name }}_genotype_hierarchy_groups_filterset1"
                                                                     multiple="true" data-actions-box="true"
                                                                     data-width="auto" data-size="10" data-live-search="true"
                                                                     data-container="body">
                                                    {% for value in unique_values %}
                                                        <option value="{{ value }}">{{ value }}</option>
                                                    {% endfor %}
                                                     </select>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                    <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                          data-bs-target="#sample_source_site_filter1">
                                        Source site
                                        {% if 'source_site' in session['validatedfields_exp2obs_map'] %}
                                            ({{session['validatedfields_exp2obs_map']['source_site']}})
                                        {% endif %}
                                    </span>
                            </div>
                            <div id="sample_source_site_filter1" class="accordion-collapse collapse"> <!--Field source_type-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_source_site_filterset1"
                                            data-live-search="true" data-actions-box="true"
                                            name="select_source_site_filterset1" data-size="10" multiple="true"
                                            tabindex="null">
                                        {% if 'source_site' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['source_site'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                    <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                          data-bs-target="#sample_source_type_filter1">
                                        Source type
                                        {% if 'source_type' in session['validatedfields_exp2obs_map'] %}
                                            ({{session['validatedfields_exp2obs_map']['source_type']}})
                                        {% endif %}
                                    </span>
                            </div>
                            <div id="sample_source_type_filter1" class="accordion-collapse collapse"> <!--Field source_type-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_source_type_filterset1"
                                            data-live-search="true" data-actions-box="true"
                                            name="select_source_type_filterset1" data-size="10" multiple="true"
                                            tabindex="null">
                                        {% if 'source_type' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['source_type'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                    <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                          data-bs-target="#geoloc_id_filter1">
                                        Geolocation id
                                        {% if 'geoloc_id' in session['validatedfields_exp2obs_map'] %}
                                            ({{session['validatedfields_exp2obs_map']['geoloc_id']}})
                                        {% endif %}
                                    </span>
                            </div>
                            <div id="geoloc_id_filter1" class="accordion-collapse collapse">
                                <!--Field source_type-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_geoloc_id_filterset1"
                                            data-live-search="true" data-actions-box="true"
                                            name="select_geoloc_id_filterset1" data-size="10" multiple="true"
                                            tabindex="null">
                                        {% if 'geoloc_id' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['geoloc_id'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                    </div>

                </div>
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span class="accordion-button collapsed fw-bold text-break" data-bs-toggle="collapse"
                              data-bs-target="#accordion_section_filters_subset2">FILTERS GROUP #2</span>
                    </div>
                    <div class="accordion-body collapse" id="accordion_section_filters_subset2">
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#primary_type_filter2">
                                    Primary type
                                    {% if 'primary_type' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['primary_type']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="primary_type_filter2" class="accordion-collapse collapse">
                                <!--div class="dropdown bootstrap-select show-tick"--> <!--Field Organism-->
                                    <select class="d-inline selectpicker" id="select_primary_type_filterset2" data-size="10"
                                            data-live-search="true" data-actions-box="true"
                                            name="select_primary_type_filterset2" multiple="true" tabindex="null">
                                        {% if 'primary_type' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['primary_type'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#secondary_type_filter2">
                                    Secondary type
                                    {% if 'secondary_type' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['secondary_type']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="secondary_type_filter2" class="accordion-collapse collapse"> <!--Field Type-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_secondary_type_filterset2" data-size="10"
                                            data-live-search="true" data-container="body" data-live-search="true" data-actions-box="true"
                                            name="select_serotypes_filterset2" multiple="true" tabindex="null">
                                        {% if 'secondary_type' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['secondary_type'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#genetic_profile_filter2">
                                    Genetic profile
                                    {% if 'genetic_profile' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['genetic_profile']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="genetic_profile_filter2" class="accordion-collapse collapse">
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_genetic_profile_filterset2"
                                            data-size="10" data-actions-box="true"
                                            name="select_genetic_profile_filterset2" multiple="true" tabindex="null"
                                            data-live-search="true">
                                        {% if 'genetic_profile' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['genetic_profile'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#phenotypic_profile_filter2">
                                    Phenotypic profile
                                    {% if 'phenotypic_profile' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['phenotypic_profile']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="phenotypic_profile_filter2" class="accordion-collapse collapse"> <!--Field SISTR-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_phenotypic_profile_filterset2"
                                            data-size="10" data-actions-box="true"
                                            name="select_phenotypic_profile_filterset2" multiple="true" tabindex="null"
                                            data-live-search="true">
                                        {% if 'phenotypic_profile' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['phenotypic_profile'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#date_range_filter2">
                                      Date range 
                                      {% if 'date' in session['validatedfields_exp2obs_map'] %}
                                      ({{session['validatedfields_exp2obs_map']['date']}})
                                      {% endif %}
                                </span>
                            </div>
                            <div id="date_range_filter2" class="accordion-collapse collapse"> <!--Field IsolatDate-->
                                <span>
                                <label for="start_date_filterset2">Start:</label>
                                <input type="date" id="start_date_filterset2" name="start_date_filterset2">
                                <br/>
                                <label for="end_date_filterset2">End  :</label>
                                <input type="date" id="end_date_filterset2" name="end_date_filterset2">
                                </span>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#cluster_id_filter2">
                                    Cluster ID
                                    {% if 'cluster_id' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['cluster_id']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="cluster_id_filter2" class="accordion-collapse collapse">
                                <!--Field IsolatDate-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_cluster_id_filterset2"
                                            name="select_cluster_id_filterset2" multiple="true" data-actions-box="true"
                                            data-width="auto" data-size="10" data-live-search="true"
                                            data-container="body">
                                        {% if 'cluster_id' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['cluster_id'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                      data-bs-target="#investigation_id_filter2">
                                    Investigation ID
                                    {% if 'investigation_id' in session['validatedfields_exp2obs_map'] %}
                                        ({{session['validatedfields_exp2obs_map']['investigation_id']}})
                                    {% endif %}
                                </span>
                            </div>
                            <div id="investigation_id_filter2" class="accordion-collapse collapse">
                                <!--Field IsolatDate-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_investigation_id_filterset2"
                                            name="select_investigation_id_filterset2" multiple="true"
                                            data-width="auto" data-size="10" data-live-search="true"
                                            data-container="body" data-actions-box="true">
                                        {% if 'investigation_id' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['investigation_id'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                    <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                          data-bs-target="#genotype_hierarchy_groups_filter2">
                                        Hierarchical subtypes
                                        {% if 'hierarchical_subtype' in session['validatedfields_exp2obs_map'] %}
                                            ({{session['validatedfields_exp2obs_map']['hierarchical_subtype']}})
                                        {% endif %}
                                    </span>
                            </div>
                            <div id="genotype_hierarchy_groups_filter2" class="accordion-collapse collapse">
                                <!--Field IsolatDate-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                {% for field_name, unique_values in  filters_fields2values_dict.items() %}
                                    {% if 'hs_level_' in field_name %}
                                        <div class="accordion-item">
                                            <div class="accordion-header">
                                                    <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                                          data-bs-target="#{{ field_name }}_f2_accordion_item_content">
                                                        {{ field_name }}
                                                    </span>
                                            </div>
                                            <!--span class="fw-bold">{{ field_name }}</span-->
                                            <div id="{{ field_name }}_f2_accordion_item_content" class="accordion-collapse collapse">
                                                <select class="d-inline selectpicker"
                                                        id="select_{{ field_name }}_genotype_hierarchy_groups_filterset2"
                                                        name="select_{{ field_name }}_genotype_hierarchy_groups_filterset2"
                                                        multiple="true" data-actions-box="true"
                                                        data-width="auto" data-size="10" data-live-search="true"
                                                        data-container="body">
                                                    {% for value in unique_values %}
                                                        <option value="{{ value }}">{{ value }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                    <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                          data-bs-target="#sample_source_site_filter2">
                                        Source site
                                        {% if 'source_site' in session['validatedfields_exp2obs_map'] %}
                                            ({{session['validatedfields_exp2obs_map']['source_site']}})
                                        {% endif %}
                                    </span>
                            </div>
                            <div id="sample_source_site_filter2" class="accordion-collapse collapse"> <!--Field source_type-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_source_site_filterset2"
                                            data-live-search="true" data-actions-box="true"
                                            name="select_source_site_filterset2" data-size="10" multiple="true"
                                            tabindex="null">
                                        {% if 'source_site' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['source_site'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                    <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                          data-bs-target="#sample_source_type_filter2">
                                        Source type
                                        {% if 'source_type' in session['validatedfields_exp2obs_map'] %}
                                            ({{session['validatedfields_exp2obs_map']['source_type']}})
                                        {% endif %}
                                    </span>
                            </div>
                            <div id="sample_source_type_filter2" class="accordion-collapse collapse"> <!--Field source_type-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_source_type_filterset2"
                                            data-live-search="true" data-actions-box="true"
                                            name="select_source_type_filterset2" data-size="10" multiple="true"
                                            tabindex="null">
                                        {% if 'source_type' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['source_type'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header">
                                    <span class="accordion-button collapsed text-break" data-bs-toggle="collapse"
                                          data-bs-target="#geoloc_id_filter2">
                                        Geolocation id
                                        {% if 'geoloc_id' in session['validatedfields_exp2obs_map'] %}
                                            ({{session['validatedfields_exp2obs_map']['geoloc_id']}})
                                        {% endif %}
                                    </span>
                            </div>
                            <div id="geoloc_id_filter2" class="accordion-collapse collapse">
                                <!--Field source_type-->
                                <!--div class="dropdown bootstrap-select show-tick"-->
                                    <select class="d-inline selectpicker" id="select_geoloc_id_filterset2"
                                            data-live-search="true" data-actions-box="true"
                                            name="select_geoloc_id_filterset2" data-size="10" multiple="true"
                                            tabindex="null">
                                        {% if 'geoloc_id' in filters_fields2values_dict %}
                                            {% for value in filters_fields2values_dict['geoloc_id'] %}
                                                <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                <!--/div-->
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            <hr style="padding: 1px;margin: 0.1em;">
            <div class="text-left">
                <span class="fw-bold">GROUP BY:</span>
                <select class="selectpicker show-tick mb-1" id="groupby_selector" style="right: 0; left: auto;"
                        name="groupby_selector" multiple="true"
                        data-width="100%" data-size="5" data-live-search="true"  data-actions-box="false"
                        title="Select a variable ..."
                >
                            <option data-hidden="true"></option>
                    {% if df_column_names %}
                        {% for item in df_column_names %}
                            {% if item in session['validatedfields_exp2obs_map']%}
                                <option value="{{ item }}">{{ item }} ({{session['validatedfields_exp2obs_map'][item]}})</option>
                            {% else %}
                                <option value="{{ item }}">{{ item }}</option>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    <!--option value="">---DEACTIVATE GROP BY---</option-->
                </select>

            </div>

            
            <hr style="padding: 1px;margin: 0em;">
            <div class="form-check form-switch m-2">
                <input id="percent_scale_toggle" onclick="postPlotData(this.id,false)" class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
                <label class="form-check-label" for="percent_scale_toggle">Enable y-axis <b>% total scale</b></label>
            </div>
            <div class="form-check form-switch m-2">
                <input id="log_scale_toggle" onclick="postPlotData(this.id,false)" class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault" >
                <label class="form-check-label" for="log_scale_toggle">Enable y-axis <b>log scale</b></label>
            </div>
            
            <hr style="padding: 1px;margin: 0;">
            <div id="upload_button_div">
                <form id="upload_file_form" action="/" method="post" enctype="multipart/form-data" 
                class="d-flex flex-row flex-nowrap justify-content-center">
                    <input type='file' accept=".xlsx,.csv" onchange=startFileUpload() name='file' id='file_selector' hidden/>
                    <div class="tooltip">
                        <button type="button" id="upload_data_button" onclick="openFileUploadDialog()" class="btn btn-primary m-1 shadow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                            </svg>
                            UPLOAD
                        </button>
                        <span class="tooltiptext">Upload file</span>
                    </div>
                    <div class="tooltip">
                        <button type="button" id="apply_filters_button" onclick="postPlotData()" class="btn btn-danger m-1 shadow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16">
                                <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2z"/>
                            </svg>
                            APPLY
                        </button>
                        <span class="tooltiptext">Apply selected filters</span>
                    </div>
                </form>
            </div>

            <hr style="padding: 1px;margin: 0;">

            <div class="accordion-item" id="trace_names_colors" style="display:none;">
                <div class="accordion-header">
                    <!--p style="text-align: center;margin: 0em;">TRACE CONTROLS:</p-->
                    <span class="accordion-button collapsed fw-bold" data-bs-toggle="collapse"
                    data-bs-target="#plot_controls">PLOT CONTROLS</span>
                </div>
                <div id="plot_controls" class="accordion-collapse collapse show">
                    <div class="p-1 d-flex gap-1">
                        <button type="button" onclick=switchLayout() class="btn-sm btn-primary flex-fill shadow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-layout-wtf" viewBox="0 0 16 16">
                                <path d="M5 1v8H1V1zM1 0a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1V1a1 1 0 0 0-1-1zm13 2v5H9V2zM9 1a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM5 13v2H3v-2zm-2-1a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1zm12-1v2H9v-2zm-6-1a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1z"/>
                            </svg>
                            Switch layout
                            
                        </button> 
                        <button type="button" id="reset_filters_button" onclick="resetAllFilters()" 
                        class="btn-sm btn-primary flex-fill shadow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bootstrap-reboot" viewBox="0 0 16 16">
                                <path d="M1.161 8a6.84 6.84 0 1 0 6.842-6.84.58.58 0 1 1 0-1.16 8 8 0 1 1-6.556 3.412l-.663-.577a.58.58 0 0 1 .227-.997l2.52-.69a.58.58 0 0 1 .728.633l-.332 2.592a.58.58 0 0 1-.956.364l-.643-.56A6.812 6.812 0 0 0 1.16 8z"/>
                                <path d="M6.641 11.671V8.843h1.57l1.498 2.828h1.314L9.377 8.665c.897-.3 1.427-1.106 1.427-2.1 0-1.37-.943-2.246-2.456-2.246H5.5v7.352zm0-3.75V5.277h1.57c.881 0 1.416.499 1.416 1.32 0 .84-.504 1.324-1.386 1.324h-1.6z"/>
                              </svg>
                            Reset
                        </button>    
                    </div>
                    <hr style="padding: 1px;margin: 3px;">    
                    <div id="trace_names_colors_list"></div>
                    <hr style="padding: 1px;margin: 3px;">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <span class="accordion-button collapsed fw-bold" data-bs-toggle="collapse"
                            data-bs-target="#plot_title_controls">CHANGE PLOT NAME</span>
                        <div id="plot_title_controls" class="collapse">
                            <select class="selectpicker show-tick mb-1" id="plot_title_selectpicker" style="right: 0; left: auto;"
                                    data-width="100%" data-size="5" data-live-search="true" data-actions-box="false"
                                    title="Select plot title to change ..."
                            >
                            </select>
                            <input id="plot_title_input_field" type="text" name="0" value="" placeholder="Enter a new plot title" class="form-control mb-1"
                                onchange="updatePlotAttr(this)" style="background-color: whitesmoke;">
                        </div>        
                        </div> <!--Plotly.relayout('plotDiv_sample_accum_plot', {'title':'TEST'})-->
                    </div>    
                    <hr style="padding: 1px;margin: 3px;">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <span class="accordion-button collapsed fw-bold" data-bs-toggle="collapse"
                            data-bs-target="#tab_name_change">CHANGE TAB NAME</span>
                        </div>
                        <div id="tab_name_change" class="collapse">
                            <select class="selectpicker show-tick mb-1" id="tab_title_selectpicker" style="right: 0; left: auto;"
                                        data-width="100%" data-size="5" data-live-search="true" data-actions-box="false"
                                        title="Select tab title to change ..."
                                >
                            <input id="tab_title_input_field" type="text"  value="" placeholder="Enter a new tab title" class="form-control mb-1"
                                        onchange="updateTabTitle(this.value)" style="background-color: whitesmoke;">
                        </div>            
                        
                    </div>            
                    <hr style="padding: 1px;margin: 3px;">
                    <div id='sunburst_max_levels_panel' style="display: flex; flex-direction:row; justify-content: space-between; align-items: center">
                    <label  for="sunburst_max_levels_slider"># of hierarchical levels to render:</label>
                    <span style="font-weight:bold; padding: 0px 5px 0px 0px;" id="sunburst_max_levels_slider_current_value">3</span>
                    </div>
                    <input id="sunburst_max_levels_slider" style="width:100%" type="range" min="1" value="3" class="form-control-range"  step="1"
                           onchange="updateSunburstVisibleLevels()" oninput="$('#sunburst_max_levels_slider_current_value').html($(this).val())"
                    >

                </div>
            </div>



            <div class="accordion-item">
                <div class="accordion-header">
                    <span class="accordion-button collapsed fw-bold" data-bs-toggle="collapse"
                          data-bs-target="#settings_selected">SETTINGS APPLIED</span>
                </div>
                <div id="settings_selected" class="accordion-collapse collapse">
                    <div class="settings_selected_grid" style="display:grid; max-width: 100%; grid-template-columns: auto; grid-auto-columns: min-content;">
                        <span>Session ID:</span><span>{{session_id}}</span>
                        <span>Filename:</span><span>{{file_uploaded}}</span>
                        <span>Dashboard version:</span><span>0.0.5</span>
                        <span>Filters group #1:</span><span id="settings_selected_group1">-</span>
                        <span>Filters group #2:</span><span id="settings_selected_group2">-</span>
                        <span>Group by:</span><span id="settings_selected_groupby">-</span>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header">
                        <span class="accordion-button collapsed fw-bold" data-bs-toggle="collapse"
                              data-bs-target="#export_data_options">EXPORT DATA</span>
                </div>
                <div id="export_data_options" class="accordion-collapse collapse mb-1 text-center">
                    <button type="button" id="save_plots_2_button" onclick="saveweb2html()" class="btn btn-primary m-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-html" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M14 4.5V11h-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zm-9.736 7.35v3.999h-.791v-1.714H1.79v1.714H1V11.85h.791v1.626h1.682V11.85h.79Zm2.251.662v3.337h-.794v-3.337H4.588v-.662h3.064v.662zm2.176 3.337v-2.66h.038l.952 2.159h.516l.946-2.16h.038v2.661h.715V11.85h-.8l-1.14 2.596H9.93L8.79 11.85h-.805v3.999zm4.71-.674h1.696v.674H12.61V11.85h.79v3.325Z"/>
                        </svg>
                        HTML
                    </button>
                    <button type="button" id="save_plots_2_pdf_button" onclick="saveweb2pdf()" class="btn btn-primary m-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-pdf" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM1.6 11.85H0v3.999h.791v-1.342h.803q.43 0 .732-.173.305-.175.463-.474a1.4 1.4 0 0 0 .161-.677q0-.375-.158-.677a1.2 1.2 0 0 0-.46-.477q-.3-.18-.732-.179m.545 1.333a.8.8 0 0 1-.085.38.57.57 0 0 1-.238.241.8.8 0 0 1-.375.082H.788V12.48h.66q.327 0 .512.181.185.183.185.522m1.217-1.333v3.999h1.46q.602 0 .998-.237a1.45 1.45 0 0 0 .595-.689q.196-.45.196-1.084 0-.63-.196-1.075a1.43 1.43 0 0 0-.589-.68q-.396-.234-1.005-.234zm.791.645h.563q.371 0 .609.152a.9.9 0 0 1 .354.454q.118.302.118.753a2.3 2.3 0 0 1-.068.592 1.1 1.1 0 0 1-.196.422.8.8 0 0 1-.334.252 1.3 1.3 0 0 1-.483.082h-.563zm3.743 1.763v1.591h-.79V11.85h2.548v.653H7.896v1.117h1.606v.638z"/>
                        </svg>
                        PDF
                    </button>
                    <button type="button" id="save_plots_2_csv_button" onclick="postPlotData(null,true)" class="btn btn-primary m-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-csv" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM3.517 14.841a1.13 1.13 0 0 0 .401.823q.195.162.478.252.284.091.665.091.507 0 .859-.158.354-.158.539-.44.187-.284.187-.656 0-.336-.134-.56a1 1 0 0 0-.375-.357 2 2 0 0 0-.566-.21l-.621-.144a1 1 0 0 1-.404-.176.37.37 0 0 1-.144-.299q0-.234.185-.384.188-.152.512-.152.214 0 .37.068a.6.6 0 0 1 .246.181.56.56 0 0 1 .12.258h.75a1.1 1.1 0 0 0-.2-.566 1.2 1.2 0 0 0-.5-.41 1.8 1.8 0 0 0-.78-.152q-.439 0-.776.15-.337.149-.527.421-.19.273-.19.639 0 .302.122.524.124.223.352.367.228.143.539.213l.618.144q.31.073.463.193a.39.39 0 0 1 .152.326.5.5 0 0 1-.085.29.56.56 0 0 1-.255.193q-.167.07-.413.07-.175 0-.32-.04a.8.8 0 0 1-.248-.115.58.58 0 0 1-.255-.384zM.806 13.693q0-.373.102-.633a.87.87 0 0 1 .302-.399.8.8 0 0 1 .475-.137q.225 0 .398.097a.7.7 0 0 1 .272.26.85.85 0 0 1 .12.381h.765v-.072a1.33 1.33 0 0 0-.466-.964 1.4 1.4 0 0 0-.489-.272 1.8 1.8 0 0 0-.606-.097q-.534 0-.911.223-.375.222-.572.632-.195.41-.196.979v.498q0 .568.193.976.197.407.572.626.375.217.914.217.439 0 .785-.164t.55-.454a1.27 1.27 0 0 0 .226-.674v-.076h-.764a.8.8 0 0 1-.118.363.7.7 0 0 1-.272.25.9.9 0 0 1-.401.087.85.85 0 0 1-.478-.132.83.83 0 0 1-.299-.392 1.7 1.7 0 0 1-.102-.627zm8.239 2.238h-.953l-1.338-3.999h.917l.896 3.138h.038l.888-3.138h.879z"/>
                        </svg>
                        CSV
                    </button>
                </div>
            </div>
        </div>

        

    </div>
    <div id="content"> 
        <div id="load_spinner_div" class="position-relative w-100 h-100 d-flex flex-column align-items-center bg-white justify-content-center">
            <div class="spinner-border text-primary"  role="status"></div>
            <span class="text-primary">Loading data or rendering plots. Please wait ...</span>
            <label class="text-primary progressUploadBar" for="progressUploadBar" style="display: none">File upload progress</label>
            <progress class="progressUploadBar" id="progressUploadBar" value="0" max="100" style="width:80%;display: none"></progress>
        </div>

        {% if method == "GET" or get_flashed_messages()|length != 0 %}
        <div id="info_message_file_upload_request" class="position-relative w-100 h-100 d-flex flex-column align-items-center bg-white justify-content-center">
            <div class="tooltip">
                <button type="button" class="btn btn-primary" onclick="openFileUploadDialog()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32px" height="32px" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                    </svg>
            </button>
            <span class="tooltiptext">Upload file</span>
           </div>
            <a href="javascript:void(0)" onclick="openFileUploadDialog()">UPLOAD DATA TO RENDER (xlsx or csv)</a>
            <a href="{{ url_for('static',filename='ecoli_sample_data.csv') }}">Download E.coli demo dataset</a>
        </div>
        {% endif %}

        {% if not render_splash_screen %}
        <div class="d-flex flex-column plottabs shadow d-none">
            <div class="buttons">
            </div>
        </div>
        {% endif %}
    </div>

</div>
<footer class="footer border-top">
    &copy; Copyright 2021. <a href="https://www.nml-lnm.gc.ca/">Canada's National Microbiology Laboratory</a>
</footer>


<!--Script to handle click events in the Plotly graphs-->
<script type="text/javascript" id="renderplots">
    console.log('START of script on every page load, method: {{ method }}');
    $(document).ready(function(){$('[data-bs-toggle="tooltip"]').tooltip(); })

    document.getElementById("load_spinner_div").classList.add("d-none"); //remove spinner when page is loaded. This helps when rendering heavy large plots

    //resize plots on windows resize        
    window.addEventListener('resize', resizePlots);

    {% if method == "POST" and render_splash_screen == False %}
        renderplots({{plots | safe}});
    {% endif %}

    //always render trace control upon page every load
    $(document).ready( function () {
        renderTraceControls();
        updatePlotTitlesSection();
        updateTabTitlesSection();
        updateSunburstMaxLevels();
    })

    $("#plot_title_selectpicker").change(function(){
            document.getElementById("plot_title_input_field").value = $("#plot_title_selectpicker option:selected")[0].textContent
    })

        
    $("#tab_title_selectpicker").change(function(){
        document.getElementById("tab_title_input_field").value = $("#tab_title_selectpicker option:selected")[0].textContent
    })

    function update_validate_table_row(selected_observed_value, expected_value, tr_html){
        let validation_table_metadata = {}
        let header2index_map={}

        {%if metadata%}
            validation_table_metadata = {{ metadata | safe }};
        {% endif %}
        if (validation_table_metadata === {}){
            console.log("update_validate_table_row(): ERROR: validation_table_metadata not provided!")
        }
        
        Object.keys(validation_table_metadata['warnings']).forEach((key)=>{
            if(validation_table_metadata['warnings'][key] === ''){
                validation_table_metadata['warnings'][key]='-'
            }    
        })

        document.querySelectorAll('.input_variables_table tr')[0].querySelectorAll('th').forEach(function(element,index){
            header2index_map[String(element.textContent)]=index;
        })

        if(expected_value ==='sample_id' &&
            validation_table_metadata['fields_counts_observed'][selected_observed_value] !== validation_table_metadata['fields_counts_unique_observed'][selected_observed_value]){
            validation_table_metadata['warnings'][selected_observed_value]='Found duplicate values. Sample identifiers should be unique.'
        }
        tr_html.getElementsByTagName('td')[header2index_map['Total']].textContent=validation_table_metadata['fields_counts_observed'][selected_observed_value]
        tr_html.getElementsByTagName('td')[header2index_map['Unique']].textContent=validation_table_metadata['fields_counts_unique_observed'][selected_observed_value]
        tr_html.getElementsByTagName('td')[header2index_map['Missing']].textContent=validation_table_metadata['fields_counts_missing_observed'][selected_observed_value]
        tr_html.getElementsByTagName('td')[header2index_map['Warnings']].textContent=validation_table_metadata['warnings'][selected_observed_value]
    } 
</script>

</body>
</html>